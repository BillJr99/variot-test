{"README.md":"# MakeCode Extension for ESP8266 Wifi Modules and VarIOT IoT Platform\n\nThis extension is based upon a form from [https://github.com/alankrantas/pxt-ESP8266_ThingSpeak](https://github.com/alankrantas/pxt-ESP8266_ThingSpeak) for the ThingSpeak platform, for use with micro:bit and the ESP8266 wifi module with VarIOT.\n\n# MakeCode Extension for ESP8266 Wifi Modules and ThingSpeak IoT Platform\n\n![pctdetail 775-090 1](https://user-images.githubusercontent.com/44191076/50425186-76ada780-08ac-11e9-956c-9ebd6be09bb2.jpg)\n![92153_wm_logo](https://user-images.githubusercontent.com/44191076/58067910-d68d4d80-7bc1-11e9-9ea8-5605837dd5d5.png)\n\nThis extension/package is heavily modified from [elecfreaks/pxt-esp8266iot](https://github.com/elecfreaks/pxt-esp8266iot), also derived from [my first modification](https://github.com/alankrantas/pxt-esp8266iot) and my [micro:bit web server project](https://www.hackster.io/alankrantas/wifi-web-server-on-bbc-micro-bit-and-esp-01-esp8266-498e0d). This version has less blocks and checks the AT responses whenever the ESP8266 tries to connect Wifi, ThingSpeak as well as uplolding data.\n\nThis extension is primary targeted for ESP-01/ESP-01S or similar [ESP8266](https://github.com/esp8266/esp8266-wiki/wiki) Wifi modules loaded with factory firmware, so that you can make ThingSpeak IoT projects on [BBC micro:bits](https://microbit.org/).\n\nYou need a account and a channel on [ThingSpeak](https://thingspeak.com/) to get the write API key. Please do not share your Wifi and API info online.\n\n# Note to Users\n\nThis extension/driver is designed for **AI-Thinker ESP-01/ESP-01S** ESP8266 boards with their (older) default AT firmwares, which are dated from around 2014-2016. I have tested it with regular ESP8266 boards flashed with up-to-date AT firmwares, and it works to some extent. \n\nTo be honest, using an external WiFi chip with micro:bit is not an elegent solution. There's simply too many factors can go wrong in both hardware and software. The only way to see what's wrong is using an USB-to-TTL cable or module (most of the products should work) to read the AT responses directly from your computer.\n\nPlease beware that this is more like an experiment to bring IoT project to micro:bit, and very possibly outdated/unusable for more recent products. I would say using a ESP8266 (NodeMCU or D1 mini, etc) with standard MicroPython would be a easier choice to make IoT projects.\n\nNow, some common questions people sent me:\n\nQ: <i>Why it didn't work? Can you help me????? I need this for my own project!!!!!</i>\n\nA: Unless I have the same hardware as you and you had copied the AT responses (which people never did) so that I can tell what's wrong, I don't have time to guess every single one of the possibility. And please, don't try to trick me/hint that I should do free work for you ASAP.\n\nQ: <i>Can you modify the code so that I can ___ ?</i>\n\nA: This extension is for everyone and might be currently used by some people. I won't modify it for your own purpose unless you have found serious bugs that I can confirm/repeat and fix. You are welcome to fork it and modify it yourself though. You can import your own extension with its Github URL in the MakeCode editor.\n\nQ: <i>Can you modify the code so that I can receive data from ThinkSpeak or somewhere?</i>\n\nA: No, because receiving and parsing incoming raw HTTP data would be more diffcult and messy to implement with MakeCode blocks. Again, it would be far more easier to use regular ESP8266 boards with MicroPython.\n\n## Wiring\n\n![esp8266-pinout](https://user-images.githubusercontent.com/44191076/50428909-fc097a00-08f5-11e9-91f1-921d1b957f29.png)\n\nConnect VCC and CH to 3.3V (sufficint power needed, about 200-400 mA at least; the power from micro:bit's USB port alone is NOT ENOUGH), GND to GND, TX (transmit) and RX (receive) to two I/O pins, ignore the rest. See [here](https://components101.com/wireless/esp8266-pinout-configuration-features-datasheet) for more details. Sometimes you might also need to unplug and re-plug power to start up the ESP8266 properly.\n\nYou can also add a USB-to-TTL module to read full AT responses from your ESP8266 via terminal software on your computer: (The LED in the circuit is not needed)\n\n![microbit_esp8266_ArNB60xdJd](https://user-images.githubusercontent.com/44191076/57862847-9c235980-782b-11e9-9588-3e7fe76342ee.png)\n\nNoted that the Tx and Rx in the picture above represents the reassigned serial port pins of micro:bit:\n\n* Tx of micro:bit -> Rx of ESP8266\n* Rx of micro:bit -> Tx of ESP8266\n\n## Sample Code\n\nUse initialize block to connect to your Wifi router, and use upload block to update data to your channel on ThingSpeak.\n\nIf it failed to connect to Wifi in the first place, the update block would do nothing. If the update block failed to connect to ThingSpeak first, it would not send the data. You can use other blocks to check the status.\n\nIs is also recommended to wait several seconds between each update. Not every connect or update attempt would be successful on ThingSpeak.\n\n![microbit-screenshot](https://user-images.githubusercontent.com/44191076/58189752-a642cd80-7ced-11e9-8557-3be87aa795fa.png)\n\n```blocks\nESP8266_ThingSpeak.connectWifi(\nSerialPin.P0,\nSerialPin.P1,\nBaudRate.BaudRate115200,\n\"your_ssid\",\n\"your_pw\"\n)\nbasic.forever(function () {\n    ESP8266_ThingSpeak.connectThingSpeak(\n    \"api.thingspeak.com\",\n    \"your_write_api_key\",\n    0,\n    0,\n    0,\n    0,\n    0,\n    0,\n    0,\n    0\n    )\n    ESP8266_ThingSpeak.wait(5000)\n})\n```\n\nIn the pic below is the test result of uploading analog readings of MQ7/MQ2 sensors.\n\n![1](https://user-images.githubusercontent.com/44191076/57868088-e52bdb80-7834-11e9-8c8a-29c5932cd8ab.jpg)\n\n## License\n\nMIT\n\n## Supported targets\n\n* for PXT/microbit\n","main.ts":"/**\n * MakeCode extension for ESP8266 Wifi modules and VarIOT\n */\n//% color=#009b5b icon=\"\\uf1eb\" block=\"ESP8266 VarIOT\"\nnamespace ESP8266VarIOT {\n\n    let wifi_connected: boolean = false\n    let variot_connected: boolean = false\n    let last_upload_successful: boolean = false\n\n    // write AT command with CR+LF ending\n    function sendAT(command: string, wait: number = 100) {\n        serial.writeString(command + \"\\u000D\\u000A\")\n        basic.pause(wait)\n    }\n\n    // wait for certain response from ESP8266\n    function waitResponse(): boolean {\n        let serial_str: string = \"\"\n        let result: boolean = false\n        let time: number = input.runningTime()\n        while (true) {\n            serial_str += serial.readString()\n            if (serial_str.length > 200) serial_str = serial_str.substr(serial_str.length - 200)\n            if (serial_str.includes(\"OK\") || serial_str.includes(\"ALREADY CONNECTED\")) {\n                result = true\n                break\n            } else if (serial_str.includes(\"ERROR\") || serial_str.includes(\"SEND FAIL\")) {\n                break\n            }\n            if (input.runningTime() - time > 30000) break\n        }\n        return result\n    }\n\n    /**\n    * Initialize ESP8266 module and connect it to Wifi router\n    */\n    //% block=\"Initialize ESP8266|RX (Tx of micro:bit) %tx|TX (Rx of micro:bit) %rx|Baud rate %baudrate|Wifi SSID = %ssid|Wifi PW = %pw\"\n    //% tx.defl=SerialPin.P0\n    //% rx.defl=SerialPin.P1\n    //% ssid.defl=your_ssid\n    //% pw.defl=your_pw\n    export function connectWifi(tx: SerialPin, rx: SerialPin, baudrate: BaudRate, ssid: string, pw: string) {\n        wifi_connected = false\n        variot_connected = false\n        serial.redirect(\n            tx,\n            rx,\n            baudrate\n        )\n        sendAT(\"AT+RESTORE\", 1000) // restore to factory settings\n        sendAT(\"AT+CWMODE=1\") // set to STA mode\n        sendAT(\"AT+RST\", 1000) // reset\n        sendAT(\"AT+CWJAP=\\\"\" + ssid + \"\\\",\\\"\" + pw + \"\\\"\", 0) // connect to Wifi router\n        wifi_connected = waitResponse()\n        basic.pause(100)\n    }\n\n    /**\n    * Connect to VarIOT and upload data. It would not upload anything if it failed to connect to Wifi or VarIOT.\n    */\n    //% block=\"Upload data to VarIOT|URL/IP = %ip|Write API key = %write_api_key|Label = %label|Value = %value\"\n    //% ip.defl=variot.ece.drexel.edu\n    //% write_api_key.defl=your_write_api_key\n    //% port.defl=1883\n    export function sendVarIOTTelemetry(ip: string, write_api_key: string, port: string, label: string, value: number) {\n        if (wifi_connected && write_api_key != \"\") {\n            variot_connected = false\n            sendAT(\"AT+CIPSTART=\\\"TCP\\\",\\\"\" + ip + \"\\\",\" + port, 0) // connect to website server\n            variot_connected = waitResponse()\n            basic.pause(100)\n            if (variot_connected) {\n                last_upload_successful = false\n                let str: string = \"POST /api/v1/\" + write_api_key + \"/telemetry\" + \"\\r\\n\" + \"Content-Type: application/json\" + \"\\r\\n\\r\\n\" + \"{\\\"\" + label + \"\\\": \" + value + \"}\" + \"\\r\\n\\r\\n\"\n                sendAT(\"AT+CIPSEND=\" + (str.length + 2))\n                sendAT(str, 0) // upload data\n                last_upload_successful = waitResponse()\n                basic.pause(100)\n            }\n        }\n    }\n\n    /**\n    * Wait between uploads\n    */\n    //% block=\"Wait %delay ms\"\n    //% delay.min=0 delay.defl=5000\n    export function wait(delay: number) {\n        if (delay > 0) basic.pause(delay)\n    }\n\n    /**\n    * Check if ESP8266 successfully connected to Wifi\n    */\n    //% block=\"Wifi connected ?\"\n    export function isWifiConnected() {\n        return wifi_connected\n    }\n\n    /**\n    * Check if ESP8266 successfully connected to VarIOT\n    */\n    //% block=\"VarIOT connected ?\"\n    export function isVarIOTConnected() {\n        return variot_connected\n    }\n\n    /**\n    * Check if ESP8266 successfully uploaded data to VarIOT\n    */\n    //% block=\"Last data upload successful ?\"\n    export function isLastUploadSuccessful() {\n        return last_upload_successful\n    }\n\n}\n","pxt.json":"{\n    \"name\": \"pxt-esp8266_variot\",\n    \"version\": \"0.0.1\",\n    \"description\": \"MakeCode extension for ESP8266 Wifi module and VarIOT\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"microphone\": \"*\"\n    },\n    \"files\": [\n        \"README.md\",\n        \"main.ts\"\n    ],\n    \"testFiles\": [\n        \"test.ts\"\n    ],\n    \"public\": true,\n    \"targetVersions\": {\n        \"target\": \"5.0.6\",\n        \"targetId\": \"microbit\"\n    },\n    \"supportedTargets\": [\n        \"microbit\"\n    ],\n    \"preferredEditor\": \"tsprj\"\n}\n","test.ts":""}